<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Tráfego</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #chart {
      width: 900px !important;
      height: 500px !important;
    }
  </style>
</head>
<body>
  <h2>Tráfego de Servidor</h2>
  <canvas id="chart"></canvas>

  <script>
    let chart;

    async function loadData() {
      try {
        let res = await fetch("http://127.0.0.1:8001/traffic"); // backend FastAPI
        let data = await res.json();

        console.log("Dados recebidos:", data); // DEBUG → veja no console do navegador

        // Se não houver dados, mostra uma mensagem
        if (!data || Object.keys(data).length === 0) {
          console.warn("Nenhum dado de tráfego disponível ainda");
          return;
        }

        let labels = Object.keys(data);
        let inbound = labels.map(ip => data[ip].in);
        let outbound = labels.map(ip => data[ip].out);

        if (chart) {
          chart.data.labels = labels;
          chart.data.datasets[0].data = inbound;
          chart.data.datasets[1].data = outbound;
          chart.update();
        } else {
          chart = new Chart(document.getElementById("chart"), {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                { label: "Inbound", data: inbound, backgroundColor: "rgba(54, 162, 235, 0.7)" },
                { label: "Outbound", data: outbound, backgroundColor: "rgba(255, 99, 132, 0.7)" }
              ]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: "top" }
              },
              onClick: async (evt, elements) => {
                if (elements.length > 0) {
                  let index = elements[0].index;
                  let ip = chart.data.labels[index];
                  let res = await fetch(`http://127.0.0.1:8001/traffic/${ip}`);
                  let client = await res.json();
                  alert(`Detalhes de ${ip}:\n${JSON.stringify(client.protocols)}`);
                }
              }
            }
          });
        }
      } catch (err) {
        console.error("Erro ao carregar dados:", err);
      }
    }

    loadData();
    setInterval(loadData, 5000);
  </script>
</body>
</html>
